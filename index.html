async function gerarPdfFormal() {
        const { jsPDF } = window.jspdf;
        // Muda a orientação para horizontal ('l' de landscape)
        const doc = new jsPDF('l'); 
        let y = 30;
        const lineHeight = 7;
        const titleHeight = 8;
        const margin = 20;

        const logoImgPath = 'assets/logo_nova.png'; 
        const watermarkImgPath = 'icon.png';

        const loadImage = (path) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Erro ao carregar a imagem: ${path}`));
                img.src = path;
            });
        };

        let logoImg, watermarkImg;
        try {
            [logoImg, watermarkImg] = await Promise.all([
                loadImage(logoImgPath),
                loadImage(watermarkImgPath)
            ]);
        } catch (e) {
            console.error("Falha ao gerar o PDF:", e.message);
            alert("Erro ao gerar o PDF. Verifique o console para mais detalhes. A imagem pode não existir ou o caminho pode estar incorreto.");
            return;
        }

        const addHeader = (doc) => {
            // Ajuste na posição do logo para o modo horizontal
            doc.addImage(logoImg, 'PNG', 240, 10, 40, 10); 
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(10);
            doc.text("Ata de Monitoramento Online", margin, 15);
            doc.line(10, 20, 287, 20); // Ajuste na linha para a largura horizontal
        };
        
        const addWatermark = (doc) => {
            doc.saveGraphicsState();
            doc.setGState(new doc.GState({opacity: 0.1})); 
            // Posição da marca d'água ajustada para o centro da página horizontal
            doc.addImage(watermarkImg, 'PNG', 95, 80, 100, 100); 
            doc.restoreGraphicsState();
        };

        const checkPageAndAddHeader = () => {
            // A largura da página agora é 297mm (tamanho de uma folha A4 em paisagem)
            if (y + 20 > 200) { 
                doc.addPage();
                y = 30;
                addWatermark(doc);
                addHeader(doc);
            }
        };
        
        addWatermark(doc);
        addHeader(doc);
        
        const v = sel => document.querySelector(sel)?.value || "";
        // A largura para o texto também precisa ser ajustada
        const getLines = (text, width) => doc.splitTextToSize(text, width);

        const addSection = (title, content) => {
            const contentFormatted = content.trim() ? content : "N/A";
            // Ajuste na largura máxima do texto
            const lines = getLines(contentFormatted, 287 - (margin * 2)); 
            const requiredHeight = titleHeight + (lines.length * lineHeight) + lineHeight;

            if (y + requiredHeight > 200) { // A altura da página agora é 210mm
                doc.addPage();
                y = 30;
                addWatermark(doc);
                addHeader(doc);
            }

            doc.setFont("Helvetica", "bold");
            doc.setFontSize(14);
            doc.text(title, margin, y);
            y += titleHeight;

            doc.setFont("Helvetica", "normal");
            doc.setFontSize(12);
            lines.forEach(line => {
                doc.text(line, margin, y);
                y += lineHeight;
            });
            
            y += lineHeight;
        };

        // --- Gerando o conteúdo do PDF a partir dos múltiplos campos ---
        let infoPlantao = `Data: ${v('#dataPlantao')}\nHorário: ${v('#horario')}`;
        addSection("Informações do Plantão", infoPlantao);
        checkPageAndAddHeader();

        let plantonistas = "";
        document.querySelectorAll('#plantonistas .plantonista-item').forEach(item => {
            const nome = item.querySelector('.nome')?.value;
            const cargo = item.querySelector('.cargo')?.value;
            if (nome) plantonistas += `• ${nome} - ${cargo || "Sem cargo"}\n`;
        });
        addSection("Plantonistas", plantonistas);
        checkPageAndAddHeader();

        let ocorrencias = "";
        document.querySelectorAll('#ocorrencias .ocorrencia').forEach(el => {
            if (el.value) ocorrencias += `• ${el.value}\n`;
        });
        addSection("Ocorrências", ocorrencias);
        checkPageAndAddHeader();

        let portaria = "";
        document.querySelectorAll('#ocorrenciasPortaria .portaria').forEach(el => {
            if (el.value) portaria += `• ${el.value}\n`;
        });
        addSection("Ocorrências de Portaria", portaria);
        checkPageAndAddHeader();

        let ordens = "";
        document.querySelectorAll('#ordens .ordem').forEach(el => {
            if (el.value) ordens += `• ${el.value}\n`;
        });
        addSection("Ordens de Serviço", ordens);
        checkPageAndAddHeader();
        
        let viaturas = "";
        document.querySelectorAll('#viaturas .viatura-item').forEach(item => {
            const data = item.querySelector('.viatura-data').value;
            const hora = item.querySelector('.viatura-hora').value;
            const solicitante = item.querySelector('.viatura-solicitante').value;
            const veiculo = item.querySelector('.viatura-veiculo').value;
            const averiguador = item.querySelector('.viatura-averiguador').value;
            const chegada = item.querySelector('.viatura-chegada').value;
            const saida = item.querySelector('.viatura-saida').value;
            if (data || solicitante) {
                viaturas += `Data: ${data}, Hora: ${hora}\nSolicitante: ${solicitante}\nVeículo: ${veiculo}, Averiguador: ${averiguador}\nChegada: ${chegada}, Saída: ${saida}\n\n`;
            }
        });
        addSection("Envio de Viatura", viaturas);
        checkPageAndAddHeader();

        let veiculos = "";
        document.querySelectorAll('#veiculos .veiculo-item').forEach(item => {
            const data = item.querySelector('.veiculo-data').value;
            const saida = item.querySelector('.veiculo-saida').value;
            const chegada = item.querySelector('.veiculo-chegada').value;
            const nome = item.querySelector('.veiculo-nome').value;
            const condutor = item.querySelector('.veiculo-condutor').value;
            if (data || nome) {
                veiculos += `Data: ${data}\nSaída: ${saida}\nChegada: ${chegada}\nVeículo: ${nome}\nCondutor: ${condutor}\n\n`;
            }
        });
        addSection("Controle de Veículos", veiculos);
        checkPageAndAddHeader();

        const paradoxOnline = v('#paradoxOnline');
        const paradoxOffline = v('#paradoxOffline');
        let paradox = `${paradoxOnline || '0'} Online, ${paradoxOffline || '0'} Offline\nHorário: ${v('#paradoxHorario')}`;
        addSection("Controle da Paradox", paradox);
        checkPageAndAddHeader();

        let checklist = "";
        document.querySelectorAll('#checklist li input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.checked) {
                checklist += `• ${checkbox.parentNode.textContent.trim()}\n`;
            }
        });
        addSection("Checklist", checklist);
        checkPageAndAddHeader();

        let assinaturas = `Quem Passa: ${v('#assinaturaPassa')}\nQuem Recebe: ${v('#assinaturaRecebe')}`;
        addSection("Assinaturas", assinaturas);
        checkPageAndAddHeader();

        const imgInput = document.getElementById("videoAlertaImagem");
        if (imgInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imgData = e.target.result;
                const imgHeight = 100;
                const sectionTitleHeight = titleHeight + 5;
                const requiredHeight = sectionTitleHeight + imgHeight + lineHeight;

                if (y + requiredHeight > 200) {
                    doc.addPage();
                    y = 30;
                    addWatermark(doc);
                    addHeader(doc);
                }
                
                doc.setFont("Helvetica", "bold");
                doc.setFontSize(14);
                doc.text("Controle de Vídeo Alerta", margin, y);
                y += sectionTitleHeight;
                
                doc.addImage(imgData, 'JPEG', margin, y, 257, imgHeight);
                doc.save("ata_monitoramento_formal.pdf");
            };
            reader.onerror = function() {
                console.error("Erro ao carregar a imagem do arquivo de vídeo alerta.");
                doc.save("ata_monitoramento_formal.pdf");
            };
            reader.readAsDataURL(imgInput.files[0]);
        } else {
            doc.save("ata_monitoramento_formal.pdf");
        }
    }
