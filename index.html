<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ata de Monitoramento - PDF Formal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="page capa" id="capa">
    <img src="assets/image_987e83.png" alt="Capa da Ata">
    <h1 class="titulo-capa">ATA DE MONITORAMENTO</h1>
    <div class="center">
        <button class="btn" onclick="iniciarAta()">Iniciar Ata</button>
    </div>
</div>

<div class="page" id="conteudo" style="display: none;">
    <h2>Informações do Plantão</h2>
    <input id="dataPlantao" type="date">
    <select id="horario">
        <option>07:00 às 19:00</option>
        <option>19:00 às 07:00</option>
    </select>

    <h2>Plantonistas</h2>
    <div id="plantonistas">
        <input class="nome" placeholder="Nome">
        <input class="cargo" placeholder="Cargo">
    </div>
    <button class="btn" onclick="adicionarPlantonista()">+ Adicionar Plantonista</button>

    <h2>Ocorrências</h2>
    <div id="ocorrencias">
        <textarea class="ocorrencia" placeholder="Descreva a ocorrência..."></textarea>
    </div>
    <button class="btn" onclick="adicionarOcorrencia()">+ Adicionar Ocorrência</button>

    <h2>Ocorrências de Portaria</h2>
    <div id="ocorrenciasPortaria">
        <textarea class="portaria" placeholder="Descreva a ocorrência de portaria..."></textarea>
    </div>
    <button class="btn" onclick="adicionarOcorrenciaPortaria()">+ Adicionar Ocorrência de Portaria</button>

    <h2>Ordens de Serviço</h2>
    <div id="ordens">
        <textarea class="ordem" placeholder="Descreva a ordem de serviço..."></textarea>
    </div>
    <button class="btn" onclick="adicionarOrdem()">+ Adicionar Serviço</button>

    <h2>Envio de Viatura</h2>
    <input class="viatura-data" type="date">
    <input class="viatura-hora" type="time">
    <input class="viatura-solicitante" placeholder="Solicitante">
    <input class="viatura-veiculo" placeholder="Veículo">
    <input class="viatura-averiguador" placeholder="Averiguador">
    <input class="viatura-chegada" type="time">
    <input class="viatura-saida" type="time">

    <h2>Controle de Veículos</h2>
    <input class="veiculo-data" type="date">
    <input class="veiculo-saida" type="time">
    <input class="veiculo-chegada" type="time">
    <input class="veiculo-nome" placeholder="Veículo">
    <input class="veiculo-condutor" placeholder="Condutor">

    <h2>Controle de Vídeo Alerta</h2>
    <input type="file" id="videoAlertaImagem" accept="image/*">

    <h2>Controle da Paradox</h2>
    <input id="paradoxOnline" type="number" placeholder="Quantas Online">
    <input id="paradoxOffline" type="number" placeholder="Quantas Offline">
    <input type="datetime-local" id="paradoxHorario">

    <h2>Checklist</h2>
    <ul id="checklist">
        <li><input type="checkbox" checked> 04 Ramais</li>
        <li><input type="checkbox" checked> 04 Controle de TV</li>
        <li><input type="checkbox" checked> 01 Controle de Ar</li>
        <li><input type="checkbox" checked> 02 Celulares com carregador</li>
        <li><input type="checkbox" checked> 04 Mouse</li>
        <li><input type="checkbox" checked> 04 Teclado</li>
        <li><input type="checkbox" checked> 02 Lanterna</li>
        <li><input type="checkbox" checked> 01 Cabo de Bateria</li>
        <li><input type="checkbox" checked> 06 Cartões de Abastecimento</li>
        <li><input type="checkbox" checked> 06 CPU</li>
        <li><input type="checkbox" checked> 11 Monitores</li>
        <li><input type="checkbox" checked> 01 Microfone</li>
        <li><input type="checkbox" checked> Material Emergencial</li>
        <li><input type="checkbox" checked> 01 Placa Central Triflex</li>
        <li><input type="checkbox" checked> 01 Caixa de Ferramentas</li>
    </ul>

    <h2>Assinaturas</h2>
    <input id="assinaturaPassa" placeholder="Quem Passa o Plantão">
    <input id="assinaturaRecebe" placeholder="Quem Recebe o Plantão">

    <div class="center">
        <button class="btn" onclick="gerarPdfFormal()">Gerar PDF Formal</button>
    </div>
</div>

<script>
    function iniciarAta() {
        document.getElementById('capa').style.display = 'none';
        document.getElementById('conteudo').style.display = 'block';
    }

    function adicionarPlantonista() {
        const div = document.createElement('div');
        div.innerHTML = '<input class="nome" placeholder="Nome"> <input class="cargo" placeholder="Cargo">';
        document.getElementById('plantonistas').appendChild(div);
    }

    function adicionarOcorrencia() {
        const area = document.createElement('textarea');
        area.className = 'ocorrencia';
        area.placeholder = 'Descreva a ocorrência...';
        document.getElementById('ocorrencias').appendChild(area);
    }

    function adicionarOcorrenciaPortaria() {
        const area = document.createElement('textarea');
        area.className = 'portaria';
        area.placeholder = 'Descreva a ocorrência de portaria...';
        document.getElementById('ocorrenciasPortaria').appendChild(area);
    }

    function adicionarOrdem() {
        const area = document.createElement('textarea');
        area.className = 'ordem';
        area.placeholder = 'Descreva a ordem de serviço...';
        document.getElementById('ordens').appendChild(area);
    }

    async function gerarPdfFormal() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 30;
        const lineHeight = 7;
        const titleHeight = 8;
        const margin = 20;

        const logoImg = new Image();
        logoImg.src = 'assets/image_987e83.png';
        
        const addHeader = (doc) => {
          doc.addImage(logoImg, 'PNG', 150, 10, 40, 10);
          doc.setFont("Helvetica", "bold");
          doc.setFontSize(10);
          doc.text("Ata de Monitoramento Online", margin, 15);
          doc.line(10, 20, 200, 20);
        };
        
        await new Promise((resolve, reject) => {
            logoImg.onload = resolve;
            logoImg.onerror = () => {
                console.error("Erro ao carregar a imagem da logo.");
                resolve();
            };
        });

        addHeader(doc);
        
        const v = sel => document.querySelector(sel)?.value || "";
        const getLines = (text, width) => doc.splitTextToSize(text, width);

        const addSection = (title, content) => {
            const contentFormatted = content.trim() ? content : "N/A";
            const lines = getLines(contentFormatted, 210 - (margin * 2));
            const requiredHeight = titleHeight + (lines.length * lineHeight) + lineHeight;

            if (y + requiredHeight > 280) {
                doc.addPage();
                y = 30;
                addHeader(doc);
            }

            doc.setFont("Helvetica", "bold");
            doc.setFontSize(14);
            doc.text(title, margin, y);
            y += titleHeight;

            doc.setFont("Helvetica", "normal");
            doc.setFontSize(12);
            lines.forEach(line => {
                doc.text(line, margin, y);
                y += lineHeight;
            });
            
            y += lineHeight;
        };

        let infoPlantao = `Data: ${v('#dataPlantao')}\nHorário: ${v('#horario')}`;
        addSection("Informações do Plantão", infoPlantao);

        let plantonistas = "";
        document.querySelectorAll('#plantonistas .nome').forEach((el, i) => {
            const cargo = document.querySelectorAll('#plantonistas .cargo')[i].value;
            plantonistas += `• ${el.value} - ${cargo || "Sem cargo"}\n`;
        });
        addSection("Plantonistas", plantonistas);

        let ocorrencias = "";
        document.querySelectorAll('#ocorrencias .ocorrencia').forEach(el => {
            if (el.value) ocorrencias += `• ${el.value}\n`;
        });
        addSection("Ocorrências", ocorrencias);

        let portaria = "";
        document.querySelectorAll('#ocorrenciasPortaria .portaria').forEach(el => {
            if (el.value) portaria += `• ${el.value}\n`;
        });
        addSection("Ocorrências de Portaria", portaria);

        let ordens = "";
        document.querySelectorAll('#ordens .ordem').forEach(el => {
            if (el.value) ordens += `• ${el.value}\n`;
        });
        addSection("Ordens de Serviço", ordens);

        let viatura = `Data: ${v('.viatura-data')}, Hora: ${v('.viatura-hora')}\nSolicitante: ${v('.viatura-solicitante')}\nVeículo: ${v('.viatura-veiculo')}, Averiguador: ${v('.viatura-averiguador')}\nChegada: ${v('.viatura-chegada')}, Saída: ${v('.viatura-saida')}`;
        addSection("Envio de Viatura", viatura);

        let veiculo = `Data: ${v('.veiculo-data')}\nSaída: ${v('.veiculo-saida')}\nChegada: ${v('.veiculo-chegada')}\nVeículo: ${v('.veiculo-nome')}\nCondutor: ${v('.veiculo-condutor')}`;
        addSection("Controle de Veículos", veiculo);

        const paradoxOnline = v('#paradoxOnline');
        const paradoxOffline = v('#paradoxOffline');
        let paradox = `${paradoxOnline || '0'} Online, ${paradoxOffline || '0'} Offline\nHorário: ${v('#paradoxHorario')}`;
        addSection("Controle da Paradox", paradox);

        let checklist = "";
        document.querySelectorAll('#checklist li input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.checked) {
                checklist += `• ${checkbox.parentNode.textContent.trim()}\n`;
            }
        });
        addSection("Checklist", checklist);

        let assinaturas = `Quem Passa: ${v('#assinaturaPassa')}\nQuem Recebe: ${v('#assinaturaRecebe')}`;
        addSection("Assinaturas", assinaturas);

        const imgInput = document.getElementById("videoAlertaImagem");
        if (imgInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imgData = e.target.result;
                const imgHeight = 100;
                const sectionTitleHeight = titleHeight + 5;
                const requiredHeight = sectionTitleHeight + imgHeight + lineHeight;

                if (y + requiredHeight > 280) {
                    doc.addPage();
                    y = 30;
                    addHeader(doc);
                }
                
                doc.setFont("Helvetica", "bold");
                doc.setFontSize(14);
                doc.text("Controle de Vídeo Alerta", margin, y);
                y += sectionTitleHeight;
                
                doc.addImage(imgData, 'JPEG', margin, y, 170, imgHeight);
                doc.save("ata_monitoramento_formal.pdf");
            };
            reader.onerror = function() {
                console.error("Erro ao carregar a imagem do arquivo.");
                doc.save("ata_monitoramento_formal.pdf");
            };
            reader.readAsDataURL(imgInput.files[0]);
        } else {
            doc.save("ata_monitoramento_formal.pdf");
        }
    }
</script>

</body>
</html>